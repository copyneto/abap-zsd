sap.ui.define(["sap/m/PDFViewer"],                                                                                                                                                                                                                             
    function (PDFViewer) {                                                                                                                                                                                                                                     
        "use strict";                                                                                                                                                                                                                                          
        return {                                                                                                                                                                                                                                               
            onAfterRendering: function () {                                                                                                                                                                                                                    
                debugger;                                                                                                                                                                                                                                      
                let oModel = sap.ui.getCore().byId("br.com.trescoracoes.nfdwlmassa::sap.suite.ui.generic.template.ListReport.view.ListReport::ZC_SD_NF_IMP_MASSA--responsiveTable").getModel();                                                                
                oModel.attachRequestCompleted(this.onCheckItems, this);                                                                                                                                                                                        
            },                                                                                                                                                                                                                                                 
            onCheckItems: function (oEvent) {                                                                                                                                                                                                                  
                let oModel = sap.ui.getCore().byId("br.com.trescoracoes.nfdwlmassa::sap.suite.ui.generic.template.ListReport.view.ListReport::ZC_SD_NF_IMP_MASSA--responsiveTable").getModel();                                                                
                let that = this;                                                                                                                                                                                                                               
                oModel.detachRequestCompleted(that.onCheckItems, that);                                                                                                                                                                                        
                let oTable = sap.ui.getCore().byId("br.com.trescoracoes.nfdwlmassa::sap.suite.ui.generic.template.ListReport.view.ListReport::ZC_SD_NF_IMP_MASSA--listReport");                                                                                
                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                               
                oTable.attachDataReceived(function (oEvent) {                                                                                                                                                                                                  
                    sap.ui.getCore().byId("br.com.trescoracoes.nfdwlmassa::sap.suite.ui.generic.template.ListReport.view.ListReport::ZC_SD_NF_IMP_MASSA--responsiveTable-sa").setSelected(true);                                                               
                    sap.ui.getCore().byId("br.com.trescoracoes.nfdwlmassa::sap.suite.ui.generic.template.ListReport.view.ListReport::ZC_SD_NF_IMP_MASSA--responsiveTable-sa").fireSelect();                                                                    
                                                                                                                                                                                                                                                               
                });                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                               
            },                                                                                                                                                                                                                                                 
            onActionDownload: function (oEvent) {                                                                                                                                                                                                              
                                                                                                                                                                                                                                                               
                var that = this;                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                               
                /* ===================================================================&nbsp;                                                                                                                                                                   
                Recupa referência à tabela do relatório                                                                                                                                                                                                        
                =================================================================== */                                                                                                                                                                         
                var oItems = sap.ui.getCore().byId(this.oView.sId + '--responsiveTable').getSelectedItems();                                                                                                                                                   
                                                                                                                                                                                                                                                               
                /* ===================================================================&nbsp;                                                                                                                                                                   
                Verifica se alguma linha foi selecionada                                                                                                                                                                                                       
                =================================================================== */                                                                                                                                                                         
                if (!oItems.length) {                                                                                                                                                                                                                          
                    sap.m.MessageToast.show("Nenhum registro selecionado.");                                                                                                                                                                                   
                    return;                                                                                                                                                                                                                                    
                }                                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                               
                /* ===================================================================&nbsp;                                                                                                                                                                   
                Cria Diálogo dinâmico (pop-up)                                                                                                                                                                                                                 
                =================================================================== */                                                                                                                                                                         
                var oUploadDialog = new sap.m.Dialog({                                                                                                                                                                                                         
                    contentWidth: "300px",                                                                                                                                                                                                                     
                    resizable: true,                                                                                                                                                                                                                           
                    type: "Message"                                                                                                                                                                                                                            
                });                                                                                                                                                                                                                                            
                oUploadDialog.setTitle("Download");                                                                                                                                                                                                            
                                                                                                                                                                                                                                                               
                /* ===================================================================&nbsp;                                                                                                                                                                   
                Texto do Pop-up                                                                                                                                                                                                                                
                =================================================================== */                                                                                                                                                                         
                if (oItems.length == 1) {                                                                                                                                                                                                                      
                    var oText = new sap.m.Text({ text: "Deseja baixar os formulários fiscais do documento selecionado?" });                                                                                                                                    
                } else {                                                                                                                                                                                                                                       
                    var oText = new sap.m.Text({ text: "Deseja baixar os formulários fiscais dos " + oItems.length + " documentos selecionados?" });                                                                                                           
                }                                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                               
                /* ===================================================================&nbsp;                                                                                                                                                                   
                Cria botão para a carga do arquivo                                                                                                                                                                                                             
                =================================================================== */                                                                                                                                                                         
                var oTriggerButton = new sap.m.Button({                                                                                                                                                                                                        
                    text: 'Baixar',                                                                                                                                                                                                                            
                    type: 'Accept',                                                                                                                                                                                                                            
                    press: function () {                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                               
                        oUploadDialog.close();                                                                                                                                                                                                                 
                        oUploadDialog.destroy();                                                                                                                                                                                                               
                                                                                                                                                                                                                                                               
                        var oServiceUrl = "/sap/opu/odata/SAP/ZSD_IMPRESSAO_NF_SRV/";                                                                                                                                                                          
                        var oModel = new sap.ui.model.odata.ODataModel(oServiceUrl, false);                                                                                                                                                                    
                                                                                                                                                                                                                                                               
                        var aFilters = [];                                                                                                                                                                                                                     
                        /* ===================================================================&nbsp;                                                                                                                                                           
                        Recupera PDFs das linhas selecionadas                                                                                                                                                                                                  
                        =================================================================== */                                                                                                                                                                 
                        for (let i = 0; i < oItems.length; i++) {                                                                                                                                                                                              
                                                                                                                                                                                                                                                               
                            // for (let vDoctype = 1; vDoctype <= 4; vDoctype++) {                                                                                                                                                                             
                                                                                                                                                                                                                                                               
                            /* ===================================================================&nbsp;                                                                                                                                                       
                            Verifica se Arquivo existe para determinado Tipo (Doctype):                                                                                                                                                                        
                            1 - NFE                                                                                                                                                                                                                            
                            2 - CCE                                                                                                                                                                                                                            
                            3 - BOLETO                                                                                                                                                                                                                         
                            4 - MDFE                                                                                                                                                                                                                           
                            =================================================================== */                                                                                                                                                             
                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                               
                            var item = oItems[i].getBindingContext().getObject();                                                                                                                                                                              
                                                                                                                                                                                                                                                               
                            var oFilter = new sap.ui.model.Filter({                                                                                                                                                                                            
                                filters: [                                                                                                                                                                                                                     
                                    new sap.ui.model.Filter('Docnum', sap.ui.model.FilterOperator.EQ, item.Docnum)                                                                                                                                             
                                                                                                                                                                                                                                                               
                                ]                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                               
                            })                                                                                                                                                                                                                                 
                            aFilters.push(oFilter);                                                                                                                                                                                                            
                        }                                                                                                                                                                                                                                      
                                                                                                                                                                                                                                                               
                        // var oObject = oItems[i].getBindingContext().getObject();                                                                                                                                                                            
                        // var vSourceRead = "downloadCheckSet(Docnum='" + oObject.Docnum + "',Doctype='" + vDoctype + "')"&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                                                                                          
                                                                                                                                                                                                                                                               
                        function sleep(milliseconds) {                                                                                                                                                                                                         
                            const date = Date.now();                                                                                                                                                                                                           
                            let currentDate = null;                                                                                                                                                                                                            
                            do {                                                                                                                                                                                                                               
                                currentDate = Date.now();                                                                                                                                                                                                      
                            } while (currentDate - date < milliseconds);                                                                                                                                                                                       
                        }                                                                                                                                                                                                                                      
                                                                                                                                                                                                                                                               
                        var fnFunction = function () {                                                                                                                                                                                                         
                                                                                                                                                                                                                                                               
                            return new Promise(function (showSuccessMessage, showErrorMessage) {                                                                                                                                                               
                                                                                                                                                                                                                                                               
                                oModel.read('/downloadCheckSet', {                                                                                                                                                                                             
                                    filters: [new sap.ui.model.Filter(aFilters, true)],                                                                                                                                                                        
                                    //         //oModel.read(vSourceRead, null, null, true,                                                                                                                                                                    
                                                                                                                                                                                                                                                               
                                    //         oModel.read(vSourceRead, {                                                                                                                                                                                      
                                                                                                                                                                                                                                                               
                                    success: function (oData, oResponse) {                                                                                                                                                                                     
                                        for (let i = 0; i < oData.results.length; i++) {                                                                                                                                                                       
                                                                                                                                                                                                                                                               
                                            if (!oData.results[i].Value) {                                                                                                                                                                                     
                                                continue;                                                                                                                                                                                                      
                                            }                                                                                                                                                                                                                  
                                            var oSource = oServiceUrl + "downloadSet(Docnum='" + oData.results[i].Docnum + "',Doctype='" + oData.results[i].Doctype + "')/$value";                                                                             
                                            var oPDFViewer = new PDFViewer();                                                                                                                                                                                  
                                            this.getView().addDependent(oPDFViewer);                                                                                                                                                                           
                                            oPDFViewer.setSource(oSource);                                                                                                                                                                                     
                                            oPDFViewer.downloadPDF();                                                                                                                                                                                          
                                                                                                                                                                                                                                                               
                                            sleep(2000);                                                                                                                                                                                                       
                                                                                                                                                                                                                                                               
                                        }                                                                                                                                                                                                                      
                                        showSuccessMessage();                                                                                                                                                                                                  
                                                                                                                                                                                                                                                               
                                        //                 if (!oData.Value) {                                                                                                                                                                                 
                                        //                     return;                                                                                                                                                                                         
                                        //                 }                                                                                                                                                                                                   
                                                                                                                                                                                                                                                               
                                        //                 //sap.ui.core.util.File.save(oData.Value, 'device', 'pdf', 'application/pdf', 'utf-8', false);                                                                                                      
                                        //                 var oSource = oServiceUrl + "downloadSet(Docnum='" + oData.Docnum + "',Doctype='" + oData.Doctype + "')/$value";                                                                                    
                                        //                 var oPDFViewer = new PDFViewer();                                                                                                                                                                   
                                        //                 this.getView().addDependent(oPDFViewer);                                                                                                                                                            
                                        //                 oPDFViewer.setSource(oSource);                                                                                                                                                                      
                                        //                 oPDFViewer.downloadPDF();                                                                                                                                                                           
                                                                                                                                                                                                                                                               
                                    }.bind(this),                                                                                                                                                                                                              
                                                                                                                                                                                                                                                               
                                    error: function (oError) {                                                                                                                                                                                                 
                                                                                                                                                                                                                                                               
                                        showErrorMessage();                                                                                                                                                                                                    
                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                               
                                    }.bind(this),                                                                                                                                                                                                              
                                                                                                                                                                                                                                                               
                                });                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                               
                            }.bind(this))                                                                                                                                                                                                                      
                                                                                                                                                                                                                                                               
                        }.bind(this);                                                                                                                                                                                                                          
                                                                                                                                                                                                                                                               
                        /* ===================================================================&nbsp;                                                                                                                                                           
                        Chama funções                                                                                                                                                                                                                          
                        =================================================================== */                                                                                                                                                                 
                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                               
                        this.extensionAPI.securedExecution(fnFunction,                                                                                                                                                                                         
                            {                                                                                                                                                                                                                                  
                                busy: {                                                                                                                                                                                                                        
                                    set: true,                                                                                                                                                                                                                 
                                    check: false                                                                                                                                                                                                               
                                },                                                                                                                                                                                                                             
                                sActionLabel: "Mensagens"                                                                                                                                                                                                      
                            });                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                               
                        // }                                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                               
                        // }                                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                               
                        //             this.getView().setBusy(true);                                                                                                                                                                                           
                                                                                                                                                                                                                                                               
                        // oModel.read('/downloadCheckSet', {                                                                                                                                                                                                  
                        //     filters: [new sap.ui.model.Filter(aFilters, true)],                                                                                                                                                                             
                        //     // filters: new sap.ui.model.Filter(aFilters),                                                                                                                                                                                  
                        //     success: function (oData, oResponse) {                                                                                                                                                                                          
                                                                                                                                                                                                                                                               
                        //         for (let i = 0; i < oData.results.length; i++) {                                                                                                                                                                            
                                                                                                                                                                                                                                                               
                        //             if (!oData.results[i].Value) {                                                                                                                                                                                          
                        //                 continue;                                                                                                                                                                                                           
                        //             }                                                                                                                                                                                                                       
                        //             var oSource = oServiceUrl + "downloadSet(Docnum='" + oData.results[i].Docnum + "',Doctype='" + oData.results[i].Doctype + "')/$value";                                                                                  
                        //             var oPDFViewer = new PDFViewer();                                                                                                                                                                                       
                        //             this.getView().addDependent(oPDFViewer);                                                                                                                                                                                
                        //             oPDFViewer.setSource(oSource);                                                                                                                                                                                          
                        //             oPDFViewer.downloadPDF();                                                                                                                                                                                               
                                                                                                                                                                                                                                                               
                        //         }                                                                                                                                                                                                                           
                        //         this.getView().setBusy(false);                                                                                                                                                                                              
                        // const hdrMessage = oResponse.headers["sap-message"];                                                                                                                                                                                
                        // const hdrMessageObject = JSON.parse(JSON.stringify(hdrMessage))                                                                                                                                                                     
                        // const json = this.parseXmlToJson(hdrMessageObject)                                                                                                                                                                                  
                        // sap.m.MessageToast.show(json.notification.message);                                                                                                                                                                                 
                        //     }.bind(this),                                                                                                                                                                                                                   
                        //     error: function (oError) {                                                                                                                                                                                                      
                        //         this.getView().setBusy(false);                                                                                                                                                                                              
                        //         // sap.m.MessageToast.show(JSON.parse(oError.responseText).error.message.value);                                                                                                                                            
                        //     }.bind(this)                                                                                                                                                                                                                    
                        // })                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                               
                    }.bind(this)                                                                                                                                                                                                                               
                });                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                               
                /* ===================================================================&nbsp;                                                                                                                                                                   
                Cria botão de cancelar                                                                                                                                                                                                                         
                =================================================================== */                                                                                                                                                                         
                var oCancelButton = new sap.m.Button({                                                                                                                                                                                                         
                    text: 'Cancelar',                                                                                                                                                                                                                          
                    type: 'Reject',                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                               
                    press: function () {                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                               
                        oUploadDialog.close();                                                                                                                                                                                                                 
                        oUploadDialog.destroy();                                                                                                                                                                                                               
                        this.getView().removeAllDependents();                                                                                                                                                                                                  
                                                                                                                                                                                                                                                               
                    }.bind(this)                                                                                                                                                                                                                               
                });                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                               
                /* ===================================================================&nbsp;                                                                                                                                                                   
                Chama diálogo com a lógica de carga&nbsp;                                                                                                                                                                                                      
                =================================================================== */                                                                                                                                                                         
                oUploadDialog.addContent(oText);                                                                                                                                                                                                               
                oUploadDialog.setBeginButton(oCancelButton);                                                                                                                                                                                                   
                oUploadDialog.setEndButton(oTriggerButton);                                                                                                                                                                                                    
                oUploadDialog.open();                                                                                                                                                                                                                          
                                                                                                                                                                                                                                                               
            },                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                               
            showSuccessMessage: function (sMessage) {                                                                                                                                                                                                          
                this.getView().setBusy(false);                                                                                                                                                                                                                 
            },                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                               
            showErrorMessage: function (sMessage) {                                                                                                                                                                                                            
                this.getView().setBusy(false);                                                                                                                                                                                                                 
            },                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                               
            delay: function (time) {                                                                                                                                                                                                                           
                return new Promise(resolve => setTimeout(resolve, time));                                                                                                                                                                                      
            }                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                               
        };                                                                                                                                                                                                                                                     
    });                                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                               