sap.ui.define([                                                                                                                                                                                                                                                
    "sap/m/PDFViewer",                                                                                                                                                                                                                                         
     "sap/m/VBox",                                                                                                                                                                                                                                             
     "sap/m/Label",                                                                                                                                                                                                                                            
     "sap/ui/core/util/File"],                                                                                                                                                                                                                                 
function (PDFViewer){                                                                                                                                                                                                                                          
    "use strict";                                                                                                                                                                                                                                              
    return sap.ui.controller("br.com.trescoracoes.cockpitdevolucao.ext.controller.ObjectPageExt",{                                                                                                                                                             
        onAnexar: function(oEvent) {                                                                                                                                                                                                                           
                /* ===================================================================&nbsp;                                                                                                                                                                   
                Recupera a linha selecionada e verifica status                                                                                                                                                                                                 
                =================================================================== */                                                                                                                                                                         
                var sObject = oEvent.getSource().getBindingContext().getObject();                                                                                                                                                                              
                                                                                                                                                                                                                                                               
                if (sObject.Nfe == ' ' ) {                                                                                                                                                                                                                     
                    sap.m.MessageToast.show("Não é possível anexar arquivo  sem número de Nfe");                                                                                                                                                               
                    return;                                                                                                                                                                                                                                    
                }                                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                               
                /* ===================================================================&nbsp;                                                                                                                                                                   
                Cria Diálogo dinâmico (pop-up)                                                                                                                                                                                                                 
                =================================================================== */                                                                                                                                                                         
                var oUploadDialog = new sap.m.Dialog({                                                                                                                                                                                                         
                    contentWidth: "300px",                                                                                                                                                                                                                     
                    resizable: true                                                                                                                                                                                                                            
                });                                                                                                                                                                                                                                            
                oUploadDialog.setTitle("Carregar arquivo");                                                                                                                                                                                                    
                                                                                                                                                                                                                                                               
                /* ===================================================================&nbsp;                                                                                                                                                                   
                Define o serviço gateway que será chamado                                                                                                                                                                                                      
                =================================================================== */                                                                                                                                                                         
                var sServiceUrl = "/sap/opu/odata/SAP/ZSD_COCKPIT_DEVOLUCAO_ANEXO1_SRV/";                                                                                                                                                                      
                var oModel = new sap.ui.model.odata.ODataModel(sServiceUrl, );                                                                                                                                                                                 
                var sSource = sServiceUrl + "fileSet";                                                                                                                                                                                                         
                                                                                                                                                                                                                                                               
                /* ===================================================================&nbsp;                                                                                                                                                                   
                Prepara o responsável pela carga do arquivo                                                                                                                                                                                                    
                =================================================================== */                                                                                                                                                                         
                var oFileUploader = new sap.ui.unified.FileUploader({                                                                                                                                                                                          
                    width: "100%",                                                                                                                                                                                                                             
                    uploadComplete: function (oEvent) {                                                                                                                                                                                                        
                                                                                                                                                                                                                                                               
                        // Atualiza tabela do relatório após carga                                                                                                                                                                                             
                        this.oView.getController().extensionAPI.refresh();                                                                                                                                                                                     
                                                                                                                                                                                                                                                               
                        oUploadDialog.close();                                                                                                                                                                                                                 
                        oUploadDialog.destroy();                                                                                                                                                                                                               
                                                                                                                                                                                                                                                               
                        // Verifica o retorno da mensagem                                                                                                                                                                                                      
                        if (oEvent.mParameters.status == '200' ||                                                                                                                                                                                              
                            oEvent.mParameters.status == '201') {                                                                                                                                                                                              
                                                                                                                                                                                                                                                               
                            sap.m.MessageToast.show("Carga realizada com sucesso.");                                                                                                                                                                           
                        }                                                                                                                                                                                                                                      
                        else {                                                                                                                                                                                                                                 
                            if (oEvent.mParameters.response) {                                                                                                                                                                                                 
                                                                                                                                                                                                                                                               
                                if (oEvent.mParameters.responseRaw.search("<message>")) {                                                                                                                                                                      
                                    var sResponse = oEvent.mParameters.responseRaw.split("<message>")[1].split("</message>")[0];                                                                                                                               
                                    alert(sResponse);                                                                                                                                                                                                          
                                }                                                                                                                                                                                                                              
                                else {                                                                                                                                                                                                                         
                                    alert("Return Code: " + oEvent.mParameters.response, "Response", "Response");                                                                                                                                              
                                }                                                                                                                                                                                                                              
                            }                                                                                                                                                                                                                                  
                        }                                                                                                                                                                                                                                      
                    }.bind(this)                                                                                                                                                                                                                               
                });                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                               
                /* ===================================================================&nbsp;                                                                                                                                                                   
               Define parâmetros                                                                                                                                                                                                                               
                =================================================================== */                                                                                                                                                                         
                oFileUploader.setName("Simple Uploader");                                                                                                                                                                                                      
                oFileUploader.setUploadUrl(sSource);                                                                                                                                                                                                           
                oFileUploader.setSendXHR(true);                                                                                                                                                                                                                
                oFileUploader.setUseMultipart(false);                                                                                                                                                                                                          
                oFileUploader.setUploadOnChange(false);                                                                                                                                                                                                        
                                                                                                                                                                                                                                                               
                var oToken = new sap.ui.unified.FileUploaderParameter({                                                                                                                                                                                        
                    name: "x-csrf-token",                                                                                                                                                                                                                      
                    value: oModel.getSecurityToken()                                                                                                                                                                                                           
                });                                                                                                                                                                                                                                            
                oFileUploader.insertHeaderParameter(oToken);                                                                                                                                                                                                   
                                                                                                                                                                                                                                                               
                /* ===================================================================&nbsp;                                                                                                                                                                   
                Cria botão para a carga do arquivo                                                                                                                                                                                                             
                =================================================================== */                                                                                                                                                                         
                var oTriggerButton = new sap.m.Button({                                                                                                                                                                                                        
                    text: 'Upload',                                                                                                                                                                                                                            
                    type: 'Accept',                                                                                                                                                                                                                            
                    press: function () {                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                               
                        // Verifica se arquivo foi informado                                                                                                                                                                                                   
                        var domRef = oFileUploader.getFocusDomRef();                                                                                                                                                                                           
                        var file = domRef.files[0];                                                                                                                                                                                                            
                                                                                                                                                                                                                                                               
                        if (oFileUploader.getValue() === '') {                                                                                                                                                                                                 
                            sap.m.MessageToast.show("Favor selecionar um arquivo");                                                                                                                                                                            
                            return;                                                                                                                                                                                                                            
                        }                                                                                                                                                                                                                                      
                                                                                                                                                                                                                                                               
                        var oContentType = new sap.ui.unified.FileUploaderParameter({                                                                                                                                                                          
                            name: "Content-Type",                                                                                                                                                                                                              
                            value: file.type                                                                                                                                                                                                                   
                        });                                                                                                                                                                                                                                    
                        oFileUploader.insertHeaderParameter(oContentType);                                                                                                                                                                                     
                                                                                                                                                                                                                                                               
                        /* ===================================================================&nbsp;                                                                                                                                                           
                        Recupera a linha selecionada&nbsp;                                                                                                                                                                                                     
                        =================================================================== */                                                                                                                                                                 
                        var sBindingContext = this.getView().getBindingContext();                                                                                                                                                                              
                        var sPath = sBindingContext.getPath();                                                                                                                                                                                                 
                        var sObject = sBindingContext.getModel().getProperty(sPath);                                                                                                                                                                           
                                                                                                                                                                                                                                                               
                        oFileUploader.insertHeaderParameter(new sap.ui.unified.FileUploaderParameter({                                                                                                                                                         
                            name: "SLUG",                                                                                                                                                                                                                      
                            value: oFileUploader.getValue() + ";" + sObject.Guid                                                                                                                                                                               
                        }));                                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                               
                        oFileUploader.upload();                                                                                                                                                                                                                
                                                                                                                                                                                                                                                               
                    }.bind(this)                                                                                                                                                                                                                               
                });                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                               
                /* ===================================================================&nbsp;                                                                                                                                                                   
                Cria botão de cancelar                                                                                                                                                                                                                         
                =================================================================== */                                                                                                                                                                         
                var oCancelButton = new sap.m.Button({                                                                                                                                                                                                         
                    text: 'Cancelar',                                                                                                                                                                                                                          
                    type: 'Reject',                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                               
                    press: function () {                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                               
                        oUploadDialog.close();                                                                                                                                                                                                                 
                        oUploadDialog.destroy();                                                                                                                                                                                                               
                        this.getView().removeAllDependents();                                                                                                                                                                                                  
                                                                                                                                                                                                                                                               
                    }.bind(this)                                                                                                                                                                                                                               
                });                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                               
                /* ===================================================================&nbsp;                                                                                                                                                                   
                Chama diálogo com a lógica de carga&nbsp;                                                                                                                                                                                                      
                =================================================================== */                                                                                                                                                                         
                oUploadDialog.addContent(oFileUploader);                                                                                                                                                                                                       
                oUploadDialog.setBeginButton(oCancelButton);                                                                                                                                                                                                   
                oUploadDialog.setEndButton(oTriggerButton);                                                                                                                                                                                                    
                oUploadDialog.open();                                                                                                                                                                                                                          
                                                                                                                                                                                                                                                               
        },                                                                                                                                                                                                                                                     
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                                                                                                                                                                                                               
        onBaixar: function (oEvent) {                                                                                                                                                                                                                          
                                                                                                                                                                                                                                                               
            /* ===================================================================&nbsp;                                                                                                                                                                       
            Recupera a linha selecionada&nbsp;                                                                                                                                                                                                                 
            =================================================================== */                                                                                                                                                                             
            var sObject = oEvent.getSource().getBindingContext().getObject();                                                                                                                                                                                  
            var oItens = oEvent.getSource().getParent().getParent().getItems();                                                                                                                                                                                
            var line = undefined;                                                                                                                                                                                                                              
            oItens.forEach((b, index) => {                                                                                                                                                                                                                     
                if(b.mProperties.selected) line = index + 1;                                                                                                                                                                                                   
            });                                                                                                                                                                                                                                                
            /* ===================================================================&nbsp;                                                                                                                                                                       
            Prepara serviço                                                                                                                                                                                                                                    
            =================================================================== */                                                                                                                                                                             
            var vServiceUrl = "/sap/opu/odata/SAP/ZSD_COCKPIT_DEVOLUCAO_ANEXO1_SRV/";                                                                                                                                                                          
            var oModel = new sap.ui.model.odata.ODataModel(vServiceUrl, false);                                                                                                                                                                                
            var vServiceUrlRead = "fileSet(Guid='" + sObject.Guid + "',Line='" + line + "')/$value";                                                                                                                                                           
                                                                                                                                                                                                                                                               
            oModel.read(vServiceUrlRead, null, null, true,                                                                                                                                                                                                     
                /* ===================================================================&nbsp;                                                                                                                                                                   
                Chama Serviço e redireciona para outra aba                                                                                                                                                                                                     
                =================================================================== */                                                                                                                                                                         
                function (oData, oDummy, oResponse) {                                                                                                                                                                                                          
                                                                                                                                                                                                                                                               
                    sap.m.URLHelper.redirect(oResponse.requestUri, true);                                                                                                                                                                                      
                                                                                                                                                                                                                                                               
                }.bind(vServiceUrl, vServiceUrlRead),                                                                                                                                                                                                          
                                                                                                                                                                                                                                                               
                /* ===================================================================&nbsp;                                                                                                                                                                   
                Recupera mensagem de retorno e exibe na tela                                                                                                                                                                                                   
                =================================================================== */                                                                                                                                                                         
                function (error) {                                                                                                                                                                                                                             
                    if (error.response.body.search("<message>")) {                                                                                                                                                                                             
                        var sResponse = error.response.body.split("<message>")[1].split("</message>")[0];                                                                                                                                                      
                        alert(sResponse);                                                                                                                                                                                                                      
                    }                                                                                                                                                                                                                                          
                    else {                                                                                                                                                                                                                                     
                        alert('Falha ao buscar arquivo');                                                                                                                                                                                                      
                    }                                                                                                                                                                                                                                          
                });                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                               
        },                                                                                                                                                                                                                                                     
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                                                                                                                                                                                                               
        onExibir: function (oEvent) {                                                                                                                                                                                                                          
                                                                                                                                                                                                                                                               
            /* ===================================================================&nbsp;                                                                                                                                                                       
            Recupera a linha selecionada&nbsp;                                                                                                                                                                                                                 
            =================================================================== */                                                                                                                                                                             
            var sObject = oEvent.getSource().getBindingContext().getObject();                                                                                                                                                                                  
            var oItens = oEvent.getSource().getParent().getParent().getItems();                                                                                                                                                                                
            var line = undefined;                                                                                                                                                                                                                              
            oItens.forEach((b, index) => {                                                                                                                                                                                                                     
                if(b.mProperties.selected) line = index + 1;                                                                                                                                                                                                   
            });                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                               
            /* ===================================================================&nbsp;                                                                                                                                                                       
            Prepara serviço                                                                                                                                                                                                                                    
            =================================================================== */                                                                                                                                                                             
            var vServiceUrl = "/sap/opu/odata/SAP/ZSD_COCKPIT_DEVOLUCAO_ANEXO1_SRV/";                                                                                                                                                                          
            //var oModel = new sap.ui.model.odata.ODataModel(vServiceUrl, false);                                                                                                                                                                              
            var vServiceUrlRead = "fileShowSet(Guid='" + sObject.Guid + "',Line='" + line + "')/$value";                                                                                                                                                       
            var sSource = vServiceUrl + vServiceUrlRead;                                                                                                                                                                                                       
                                                                                                                                                                                                                                                               
            var opdfViewer = new PDFViewer();&nbsp;                                                                                                                                                                                                            
            this.getView().addDependent(opdfViewer);&nbsp;                                                                                                                                                                                                     
            opdfViewer.setSource(sSource);&nbsp;                                                                                                                                                                                                               
            opdfViewer.setShowDownloadButton(false);                                                                                                                                                                                                           
            opdfViewer.open();                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                               
                if (oEvent.mParameters.responseRaw.search("<message>")) {                                                                                                                                                                                      
                    var sResponse = oEvent.mParameters.responseRaw.split("<message>")[1].split("</message>")[0];                                                                                                                                               
                    alert('Falha ao exibir o arquivo');                                                                                                                                                                                                        
                }                                                                                                                                                                                                                                              
                else {                                                                                                                                                                                                                                         
                    alert('Falha ao exibir o arquivo');                                                                                                                                                                                                        
                }                                                                                                                                                                                                                                              
        }                                                                                                                                                                                                                                                      
                                                                                                                                                                                                                                                               
    });                                                                                                                                                                                                                                                        
});                                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                               